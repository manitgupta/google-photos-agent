{% extends 'base.html' %}

{% block title %}Chatbot{% endblock %}

{% block favicon %}
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ¤–</text></svg>">
{% endblock %}

{% block content %}
<div class="chat-container">
    <div class="chat-window">
        <div class="chat-message bot-message">
            <p>Hello! I'm your Google Photos assistant. How can I help you create a memory today?</p>
        </div>
    </div>
    <div class="chat-input">
        <input type="text" id="user-input" placeholder="e.g., 'Show me photos from my trip to Goa'">
        <button id="send-btn"><i class="fas fa-paper-plane"></i></button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const chatWindow = document.querySelector('.chat-window');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');

        // --- Event Listeners ---
        sendBtn.addEventListener('click', handleUserMessage);
        userInput.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                handleUserMessage();
            }
        });

        // --- Main function to handle sending a message ---
        async function handleUserMessage() {
            const message = userInput.value.trim();
            if (!message) return;

            // Display user's message
            appendMessage(message, 'user-message');
            userInput.value = '';

            // Show a thinking indicator
            const thinkingIndicator = appendMessage('<i class="fas fa-spinner fa-spin"></i>', 'bot-message thinking');

            try {
                const response = await fetch('{{ url_for("api_chatbot") }}', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: message })
                });

                // Remove the thinking indicator
                thinkingIndicator.remove();

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                handleBotResponse(data);

            } catch (error) {
                console.error('Chatbot API error:', error);
                thinkingIndicator.remove();
                appendMessage(`Sorry, I encountered an error: ${error.message}`, 'bot-message error-message');
            }
        }

        // --- Handle the bot's response based on its type ---
        function handleBotResponse(data) {
            if (data.response_type === 'text') {
                appendMessage(data.data, 'bot-message');
            } else if (data.response_type === 'photos') {
                if (data.data && data.data.length > 0) {
                    appendMessage("Here are the photos I found:", 'bot-message');
                    renderPhotos(data.data);
                } else {
                    appendMessage("I couldn't find any photos matching your request.", 'bot-message');
                }
            } else if (data.error) {
                 appendMessage(`Sorry, I encountered an error: ${data.error}`, 'bot-message error-message');
            } else {
                appendMessage("I'm not sure how to respond to that.", 'bot-message');
            }
        }

        // --- Helper to append a message to the chat window ---
        function appendMessage(content, className) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${className}`;

            const p = document.createElement('p');
            p.innerHTML = content; // Use innerHTML to render spinner icon

            messageDiv.appendChild(p);
            chatWindow.appendChild(messageDiv);

            // Scroll to the bottom
            chatWindow.scrollTop = chatWindow.scrollHeight;
            return messageDiv;
        }

        // --- Helper to render a grid of photos in the chat ---
        function renderPhotos(photos) {
            const photoContainer = document.createElement('div');
            photoContainer.className = 'chat-photo-grid';

            photos.forEach(photo => {
                const photoItem = document.createElement('div');
                photoItem.className = 'chat-photo-item';

                const img = document.createElement('img');
                img.src = photo.photo_location;
                img.alt = `Photo at ${photo.location_name || 'location'}`;

                photoItem.appendChild(img);
                photoContainer.appendChild(photoItem);
            });

            chatWindow.appendChild(photoContainer);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }
    });
</script>
<style>
    /* Add some basic styling for the photo grid in the chat */
    .chat-photo-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        gap: 5px;
        margin-top: 10px;
    }
    .chat-photo-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 5px;
    }
</style>
{% endblock %}